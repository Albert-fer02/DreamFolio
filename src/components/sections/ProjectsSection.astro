---
import { getCollection } from 'astro:content';
import {
  getProjectCoverClasses,
  getProjectSlug,
  getProjectTone,
  getProjectToneLabel,
} from '../../lib/project-presentation';
import { withBase } from '../../lib/site';

type BucketKey = 'primary' | 'workspace' | 'archived' | 'lab';
type VisibleBucketKey = Exclude<BucketKey, 'archived'>;

const bucketMeta: Record<
  BucketKey,
  { title: string; description: string; accent: string }
> = {
  primary: {
    title: 'Primary Projects',
    description: 'Current product lines and direct repos that define the active body of work.',
    accent: 'from-primary/20 to-primary/5',
  },
  workspace: {
    title: 'Workspaces',
    description: 'Containers that group related subprojects, product branches, or specialized workstreams.',
    accent: 'from-secondary/20 to-secondary/5',
  },
  archived: {
    title: 'Archived Variants',
    description: 'Earlier iterations that still matter as proof of range, branching, and product evolution.',
    accent: 'from-accent/20 to-accent/5',
  },
  lab: {
    title: 'Labs',
    description: 'Research tracks, security exploration, and interface experiments outside the main product line.',
    accent: 'from-white/[0.06] to-white/[0.02]',
  },
};

const bucketOrder: BucketKey[] = ['primary', 'workspace', 'archived', 'lab'];
const visibleBucketOrder: VisibleBucketKey[] = ['primary', 'workspace', 'lab'];

const allProjects = (await getCollection('projects'))
  .map((entry) => entry.data)
  .sort((left, right) => {
    const bucketDelta =
      bucketOrder.indexOf(left.bucket) - bucketOrder.indexOf(right.bucket);

    if (bucketDelta !== 0) {
      return bucketDelta;
    }

    if (left.featured !== right.featured) {
      return left.featured ? -1 : 1;
    }

    return left.title.localeCompare(right.title);
  });

const projects = allProjects.filter((project) => project.bucket !== 'archived');
const totalProjects = projects.length;
const activeProjects = projects.filter((project) => project.lifecycle === 'active').length;
const featuredProjects = projects.filter((project) => project.featured).length;

const groupedProjects = visibleBucketOrder.map((bucket) => ({
  bucket,
  meta: bucketMeta[bucket],
  items: projects.filter((project) => project.bucket === bucket),
}));

const itemList = {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  name: 'Dreamcoder08 Project Catalog',
  itemListOrder: 'https://schema.org/ItemListOrderAscending',
  numberOfItems: totalProjects,
  itemListElement: projects.map((project, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    name: project.title,
    description: project.summary,
    category: project.domain,
  })),
};
---

<section
  id="projects"
  class="py-20 sm:py-24 bg-gradient-to-br from-background via-muted/5 to-background relative overflow-hidden"
  aria-labelledby="projects-heading"
>
  <div class="absolute inset-0 bg-grid-pattern opacity-5" aria-hidden="true"></div>

  <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
    <header class="max-w-4xl mx-auto text-center mb-14">
      <p class="inline-flex items-center rounded-full border border-primary/30 bg-primary/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.22em] text-primary">
        Project Catalog
      </p>
      <h2 id="projects-heading" class="mt-5 text-4xl md:text-5xl font-display font-bold">
        <span class="gradient-text-cyber">All Projects</span>
        <span class="text-foreground">, organized for clarity</span>
      </h2>
      <p class="mt-5 text-lg text-muted-foreground font-tech leading-relaxed">
        This catalog is driven by typed project data inside Astro and now focuses on active work,
        workspaces, and research tracks instead of older branch history.
      </p>
    </header>

    <div class="grid gap-4 md:grid-cols-3 mb-12">
      <div class="rounded-2xl border border-border/60 bg-card/70 p-5 backdrop-blur">
        <p class="text-sm uppercase tracking-[0.18em] text-muted-foreground">Total</p>
        <p class="mt-2 text-3xl font-display font-bold text-foreground">{totalProjects}</p>
        <p class="mt-2 text-sm text-muted-foreground">Visible projects across active work, workspaces, and labs.</p>
      </div>
      <div class="rounded-2xl border border-border/60 bg-card/70 p-5 backdrop-blur">
        <p class="text-sm uppercase tracking-[0.18em] text-muted-foreground">Active</p>
        <p class="mt-2 text-3xl font-display font-bold text-primary">{activeProjects}</p>
        <p class="mt-2 text-sm text-muted-foreground">Current lines that represent the live body of work.</p>
      </div>
      <div class="rounded-2xl border border-border/60 bg-card/70 p-5 backdrop-blur">
        <p class="text-sm uppercase tracking-[0.18em] text-muted-foreground">Featured</p>
        <p class="mt-2 text-3xl font-display font-bold text-accent">{featuredProjects}</p>
        <p class="mt-2 text-sm text-muted-foreground">Priority projects that should anchor the narrative first.</p>
      </div>
    </div>

    <div class="space-y-12">
      {
        groupedProjects.map(({ bucket, meta, items }) => (
          <section aria-labelledby={`${bucket}-heading`}>
            <div class={`rounded-3xl border border-border/60 bg-gradient-to-r ${meta.accent} p-6 sm:p-7`}>
              <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
                <div>
                  <h3 id={`${bucket}-heading`} class="text-2xl sm:text-3xl font-display font-bold">
                    {meta.title}
                  </h3>
                  <p class="mt-2 max-w-3xl text-sm sm:text-base text-muted-foreground">
                    {meta.description}
                  </p>
                </div>
                <p class="text-sm font-tech uppercase tracking-[0.18em] text-muted-foreground">
                  {items.length} items
                </p>
              </div>
            </div>

            <div class="mt-6 grid gap-5 md:grid-cols-2 xl:grid-cols-3">
              {
                items.map((project) => {
                  const tone = getProjectTone(project.domain, project.bucket);
                  const coverTone = getProjectCoverClasses(tone);
                  const toneLabel = getProjectToneLabel(tone);

                  return (
                    <a
                      href={withBase(`/projects/${getProjectSlug(project.title)}/`)}
                      class="group block rounded-2xl border border-border/60 bg-card/75 shadow-sm backdrop-blur transition-all duration-300 hover:-translate-y-1 hover:border-primary/40 hover:shadow-[0_22px_60px_rgba(143,175,209,0.12)]"
                    >
                      <div class={`relative overflow-hidden rounded-t-2xl border-b border-white/8 bg-gradient-to-br ${coverTone} p-5 ring-1 ring-white/5 transition-all duration-300 group-hover:ring-primary/20`}>
                        <div class="absolute inset-0 bg-grid-pattern opacity-[0.12]" aria-hidden="true"></div>
                        <div class="relative z-10 min-h-[150px]">
                          <p class="font-code text-[10px] uppercase tracking-[0.18em] text-zinc-400">
                            {toneLabel}
                          </p>
                          <div class="mt-6 max-w-[16rem]">
                            <p class="text-2xl font-display font-bold leading-tight text-white">
                              {project.title}
                            </p>
                            <p class="mt-2 text-sm text-zinc-300">
                              {project.domain}
                            </p>
                          </div>
                          <div class="mt-8 flex items-center justify-between text-[11px] uppercase tracking-[0.16em] text-zinc-500">
                            <span>{project.lifecycle}</span>
                            <span class="text-primary transition-colors duration-300 group-hover:text-white">open project</span>
                          </div>
                        </div>
                      </div>

                      <article class="p-5">
                        <div class="flex flex-wrap items-center gap-2">
                          <span class="rounded-full bg-primary/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.16em] text-primary">
                            {project.domain}
                          </span>
                          <span class="rounded-full bg-muted px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.16em] text-muted-foreground">
                            updated {project.updatedYear}
                          </span>
                          {project.featured && (
                            <span class="rounded-full bg-accent/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.16em] text-accent">
                              featured
                            </span>
                          )}
                        </div>

                        <p class="mt-4 text-sm leading-7 text-muted-foreground">
                          {project.summary}
                        </p>

                        <div class="mt-4 flex flex-wrap gap-2">
                          {project.stack.map((tag) => (
                            <span class="rounded-full border border-border/70 px-3 py-1 text-xs text-foreground/80">
                              {tag}
                            </span>
                          ))}
                        </div>

                        <div class="mt-5 border-t border-border/60 pt-4">
                          <div class="flex items-center justify-between gap-3">
                            <div>
                              <p class="text-[11px] uppercase tracking-[0.16em] text-muted-foreground">
                                Source path
                              </p>
                              <p class="mt-2 font-code text-xs sm:text-sm text-foreground/80 break-all">
                                {project.path}
                              </p>
                            </div>
                            <div class="shrink-0 rounded-full border border-primary/20 bg-primary/[0.08] px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.16em] text-primary transition-colors duration-300 group-hover:border-primary/30 group-hover:bg-primary/[0.12]">
                              view
                            </div>
                          </div>
                        </div>
                      </article>
                    </a>
                  );
                })
              }
            </div>
          </section>
        ))
      }
    </div>
  </div>

  <script type="application/ld+json" set:html={JSON.stringify(itemList)}></script>
</section>
